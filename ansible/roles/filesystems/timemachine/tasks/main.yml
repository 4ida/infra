---
- name: Install required system packages
  apt: 
    name: "{{ item }}" 
    state: latest 
    update_cache: yes
  with_items: 
    - 'netatalk'
    - 'hfsplus'
    - 'hfsprogs'

- name: Mount the Time Machine drive
  mount:
    name: "{{ timemachine_root }}"
    src: "{{ timemachine_drive }}"
    fstype: hfsplus
    opts: defaults,nofail,force,rw
    state: mounted

- name: Remount the drive if it's read-only
  block:
    - name: Check if the drive is read-only
      shell:
        cmd: grep "[[:space:]]ro[[:space:],]" /proc/mounts | grep timemachine
      register: timemachine_ro
      failed_when: timemachine_ro.rc == 0
      changed_when: timemachine_ro.rc == 0

  rescue:
  - name: Stop the Netatalk service
    service: 
      name: netatalk
      state: stopped
    
  - name: Unmount and fsck the drive if it became read-only
    shell:
      cmd: umount "{{ timemachine_drive }}" && fsck.hfsplus "{{ timemachine_drive }}"

  - name: Mount the Time Machine drive again
    mount:
      name: "{{ timemachine_root }}"
      src: "{{ timemachine_drive }}"
      fstype: hfsplus
      opts: defaults,nofail,force,rw
      state: mounted

  - name: Start the Netatalk service
    service: 
      name: netatalk
      state: started

- name: Copy the Netatalk config
  template:
    src: afp.conf
    dest: /etc/netatalk
  register: netatalk_config

- name: Make sure the Netatalk service is running and enabled
  service: 
    name: netatalk 
    state: started 
    enabled: yes

- name: Restart Netatalk
  service:
    name: netatalk
    state: restarted
  when: netatalk_config.changed